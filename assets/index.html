<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalDrive-RS</title>
    <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
    <div class="container">
        <h2>LocalDrive-RS</h2>
        
        <input type="file" id="file" style="display:none" onchange="handleFileSelect(this)">
        
        <div class="upload-area" id="drop-zone" onclick="document.getElementById('file').click()">
            <span class="upload-icon">ðŸ“‚</span>
            <div id="label">Click to select or drag file here</div>
        </div>

        <button class="btn" onclick="upload()" id="btn">Start Upload</button>
        
        <div class="progress-container" id="progress">
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="bar"></div>
            </div>
            <div class="stats">
                <span id="speed">0 MB/s</span>
                <span id="pct">0%</span>
            </div>
        </div>

        <div class="links">
            <a href="/files">
                <span>Browse Files</span>
                <span>&rarr;</span>
            </a>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file');
        const label = document.getElementById('label');

        // Drag and Drop handlers
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('dragover');
        }

        function unhighlight(e) {
            dropZone.classList.remove('dragover');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            handleFileSelect(fileInput);
        }

        function handleFileSelect(el) {
            if(el.files.length > 0) {
                label.innerHTML = `<span class="file-name">${el.files[0].name}</span>`;
                label.style.color = 'var(--text-primary)';
            }
        }
        
        function upload() {
            let file = fileInput.files[0];
            if(!file) return alert("Please select a file first!");
            
            let btn = document.getElementById('btn');
            btn.disabled = true;
            btn.innerText = "Uploading...";
            document.getElementById('progress').style.display = 'block';
            document.body.classList.add('uploading');
            
            let xhr = new XMLHttpRequest();
            xhr.open("POST", "/upload", true);
            let start = Date.now();
            
            xhr.upload.onprogress = e => {
                if(e.lengthComputable) {
                    let pct = (e.loaded / e.total) * 100;
                    let sec = (Date.now() - start) / 1000;
                    let speed = sec > 0 ? (e.loaded/sec)/(1024*1024) : 0;
                    
                    document.getElementById('bar').style.width = pct + "%";
                    document.getElementById('pct').innerText = Math.round(pct) + "%";
                    document.getElementById('speed').innerText = speed.toFixed(2) + " MB/s";
                }
            };
            
            xhr.onload = () => { 
                btn.disabled = false; 
                btn.innerText = "Start Upload";
                document.body.classList.remove('uploading');
                if (xhr.status === 200) {
                    alert("Upload Complete!");
                    // Reset
                    document.getElementById('bar').style.width = "0%";
                    document.getElementById('pct').innerText = "0%";
                    document.getElementById('speed').innerText = "0 MB/s";
                    document.getElementById('progress').style.display = 'none';
                    label.innerText = "Click to select or drag file here";
                    fileInput.value = "";
                } else {
                    alert("Upload Failed: " + xhr.responseText);
                }
            };
            
            xhr.onerror = () => {
                btn.disabled = false;
                btn.innerText = "Start Upload";
                document.body.classList.remove('uploading');
                alert("Network Error");
            };

            let fd = new FormData(); 
            fd.append("file", file);
            xhr.send(fd);
        }
    </script>
</body>
</html>
